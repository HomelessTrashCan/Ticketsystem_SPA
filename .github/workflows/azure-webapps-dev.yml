name: Deploy to Azure Production
on:
  push:
    branches: [ "develop" ]
  workflow_dispatch:

env:
 
  AZURE_WEBAPP_PACKAGE_PATH: '.'      # set this to the path to your web app project, defaults to the repository root
  NODE_VERSION: '20.18.1'                # set this to the node version to use

permissions:
  contents: read

jobs:
  
  # UNIT TESTS (ohne Datenbank)
 
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run unit tests
      run: npm test tests/units/
      continue-on-error: false

  # INTEGRATION TESTS (mit MongoDB)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    # MongoDB Service Container
    services:
      mongodb:
        image: mongo:7
        env:
          MONGO_INITDB_ROOT_USERNAME: testuser
          MONGO_INITDB_ROOT_PASSWORD: testpass
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run integration tests
      env:
        MONGO_URI: mongodb://testuser:testpass@localhost:27017/test?authSource=admin
        SESSION_SECRET: test-secret-for-ci-only
        JWT_SECRET: test-jwt-secret-for-ci-only
        NODE_ENV: test
        GOOGLE_CLIENT_ID: dummy
        GOOGLE_CLIENT_SECRET: dummy
        GOOGLE_CALLBACK_URL: http://localhost:8080/api/auth/google/callback
      run: npm test tests/integrations/app.local.test.ts
      continue-on-error: false



  # BUILD (läuft nur wenn Tests erfolgreich)
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]  # Wartet auf beide Test-Jobs
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: npm install and build
      working-directory: .
      run: |
        echo "Installing dependencies..."
        npm ci
        
        echo "Building application..."
        npm run build --if-present
        
        # Verify dist folder exists
        if [ ! -d "dist" ]; then
          echo "ERROR: dist folder not found after build!"
          exit 1
        fi
        
        echo "Build successful, dist folder contents:"
        ls -la dist/
        
        # Remove dev dependencies to keep artifact small
        npm prune --omit=dev

    - name: Upload artifact for deployment job
      uses: actions/upload-artifact@v4
      with:
        name: node-app
        path: |
          dist/
          src/server/
          package.json
          package-lock.json
          web.config
          node_modules/
        include-hidden-files: true

  deploy:
    name: Deploy to Azure
    permissions:
      contents: none
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: 'Prod'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    
    outputs:
      webapp-url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    
    steps:
    - name: Download artifact from build job
      uses: actions/download-artifact@v4
      with:
        name: node-app
        path: .

    - name: Verify deployment package
      run: |
        echo "=== Deployment package contents ==="
        ls -la
        echo ""
        echo "=== Checking critical files ==="
        [ -f "package.json" ] && echo "✓ package.json found" || echo "✗ package.json MISSING"
        [ -f "web.config" ] && echo "✓ web.config found" || echo "✗ web.config MISSING"
        [ -f "src/server/index.js" ] && echo "✓ server/index.js found" || echo "✗ server/index.js MISSING"
        [ -d "dist" ] && echo "✓ dist folder found" || echo "✗ dist folder MISSING"
        if [ -d "dist" ]; then
          echo ""
          echo "=== dist folder contents ==="
          ls -la dist/
          [ -f "dist/index.html" ] && echo "✓ dist/index.html found" || echo "✗ dist/index.html MISSING"
        fi



  # Azure WebApp Deployment: Referenz auf Keys

    - name: 'Deploy to Azure WebApp'
      id: deploy-to-webapp
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_WEBAPPPROD_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPPPROD_PUBLISH_PROFILE }}
        package: ./
    
    - name: 'Configure App Settings'
      run: |
        echo "⚠️ WICHTIG: Konfiguriere folgende Environment Variables manuell im Azure Portal:"
        echo "  - MONGO_URI (MongoDB Connection String)"
        echo "  - GOOGLE_CLIENT_ID (aus Google Cloud Console)"
        echo "  - GOOGLE_CLIENT_SECRET (aus Google Cloud Console)"
        echo "  - SESSION_SECRET (Zufälliger String, min. 32 Zeichen)"
        echo "  - JWT_SECRET (Zufälliger String, min. 32 Zeichen)"
        echo "  - FRONTEND_URL (URL der deployed App, z.B. https://ihre-app.azurewebsites.net)"
        echo "  - NODE_ENV=production"
        echo ""
        echo "Azure Portal → Web App → Configuration → Application Settings"

  # SMOKE TESTS (nach Deployment)
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Wait for deployment to stabilize
      run: |
        URL="${{ needs.deploy.outputs.webapp-url }}/api/health"
        echo "Health check URL: $URL"
        if [ -z "${{ needs.deploy.outputs.webapp-url }}" ]; then
          echo "ERROR: webapp-url output is empty!"
          exit 1
        fi
        for i in $(seq 1 30); do
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" 2>/dev/null || true)
          if [ "$STATUS" = "200" ]; then
            echo "App is ready after attempt $i"
            exit 0
          fi
          echo "Attempt $i: Status $STATUS, waiting 10s..."
          sleep 10
        done
        echo "App not ready after 30 attempts"
        exit 1

    - name: Run smoke tests
      run: npm test tests/integrations/app.remote.test.ts
      continue-on-error: false



  # LOAD TESTS mit k6 (optional)
  load-tests:
    name: Load Tests (k6)
    runs-on: ubuntu-latest
    needs: smoke-tests
    # Optional: Nur manuell oder bei bestimmten Branches ausführen
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install k6
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
    
    - name: Run k6 load test
      run: |
        echo "Running k6 load test against production..."
        k6 run tests/k6.test.js \
          --vus 50 \
          --duration 2m \
          --out json=k6-results.json
      continue-on-error: true  # Nicht fehlschlagen wenn Thresholds nicht erreicht
    
    - name: Upload k6 results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: k6-load-test-results
        path: k6-results.json
    
    - name: Summary
      if: always()
      run: |
        echo "Load test completed. Check artifacts for detailed results."
        echo "Note: Test may show as failed if performance thresholds weren't met."
        echo "This doesn't necessarily mean the deployment failed."

